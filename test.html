<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Error Monitor SDK - å®Œæ•´åŠŸèƒ½æµ‹è¯•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 32px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #444;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title .icon {
      font-size: 24px;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin: 5px;
      transition: transform 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
    }

    button:active {
      transform: translateY(0);
    }

    button.secondary {
      background: #e0e0e0;
      color: #333;
    }

    input, select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      margin: 5px;
      min-width: 200px;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .status-card {
      background: white;
      padding: 15px;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }

    .status-label {
      color: #666;
      font-size: 12px;
      margin-bottom: 5px;
    }

    .status-value {
      color: #333;
      font-weight: 600;
      font-size: 16px;
    }

    .console {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 10px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
    }

    .console-line {
      margin: 5px 0;
      padding: 3px 0;
      border-bottom: 1px solid #333;
    }

    .console-line.success {
      color: #4ec9b0;
    }

    .console-line.error {
      color: #f48771;
    }

    .console-line.info {
      color: #9cdcfe;
    }

    .console-line .time {
      color: #808080;
      margin-right: 10px;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 10px;
    }

    .badge.success {
      background: #d4edda;
      color: #155724;
    }

    .badge.error {
      background: #f8d7da;
      color: #721c24;
    }

    .badge.info {
      background: #d1ecf1;
      color: #0c5460;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ Error Monitor SDK - å®Œæ•´åŠŸèƒ½æµ‹è¯•</h1>
    <p class="subtitle">æµ‹è¯•æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å’Œæ’ä»¶</p>

    <div class="section">
      <div class="section-title">
        <span class="icon">ğŸ“¦</span>
        <span>SDKçŠ¶æ€</span>
      </div>
      <div class="status-grid">
        <div class="status-card">
          <div class="status-label">SDKçŠ¶æ€</div>
          <div class="status-value" id="sdkStatus">æœªåˆå§‹åŒ–</div>
        </div>
        <div class="status-card">
          <div class="status-label">ä¼šè¯ID</div>
          <div class="status-value" id="sessionId">-</div>
        </div>
        <div class="status-card">
          <div class="status-label">å·²æ•è·é”™è¯¯</div>
          <div class="status-value" id="errorCount">0</div>
        </div>
        <div class="status-card">
          <div class="status-label">é¢åŒ…å±‘æ•°é‡</div>
          <div class="status-value" id="breadcrumbCount">0</div>
        </div>
        <div class="status-card">
          <div class="status-label">å½“å‰ç”¨æˆ·</div>
          <div class="status-value" id="currentUser">æœªè®¾ç½®</div>
        </div>
        <div class="status-card">
          <div class="status-label">ç¯å¢ƒ</div>
          <div class="status-value" id="environment">-</div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">
        <span class="icon">ğŸ”´</span>
        <span>é”™è¯¯æ•è·æµ‹è¯•</span>
      </div>
      <button onclick="testJSError()">JavaScripté”™è¯¯</button>
      <button onclick="testPromiseError()">Promise Rejection</button>
      <button onclick="testNetworkError()">ç½‘ç»œé”™è¯¯</button>
      <button onclick="testResourceError()">èµ„æºåŠ è½½é”™è¯¯</button>
      <button onclick="testCustomMessage()" class="secondary">è‡ªå®šä¹‰æ¶ˆæ¯</button>
      <button onclick="testUnhandledError()" class="secondary">æœªå¤„ç†é”™è¯¯</button>
    </div>

    <div class="section">
      <div class="section-title">
        <span class="icon">âš¡</span>
        <span>æ€§èƒ½ç›‘æ§æµ‹è¯•</span>
      </div>
      <button onclick="triggerSlowResource()">æ¨¡æ‹Ÿæ…¢èµ„æº</button>
      <button onclick="showWebVitals()">æŸ¥çœ‹Web Vitals</button>
      <button onclick="checkPerformance()">æ€§èƒ½æ£€æŸ¥</button>
    </div>

    <div class="section">
      <div class="section-title">
        <span class="icon">ğŸ‘£</span>
        <span>ç”¨æˆ·è¡Œä¸ºæµ‹è¯•</span>
      </div>
      <div>
        <input type="text" id="testInput" placeholder="åœ¨æ­¤è¾“å…¥æµ‹è¯•è¡Œä¸ºè¿½è¸ª...">
        <button onclick="simulateClick()">æ¨¡æ‹Ÿç‚¹å‡»</button>
        <button onclick="simulateNavigation()">æ¨¡æ‹Ÿè·¯ç”±</button>
        <button onclick="simulateHttp()">æ¨¡æ‹ŸHTTPè¯·æ±‚</button>
        <button onclick="addCustomBreadcrumb()" class="secondary">è‡ªå®šä¹‰é¢åŒ…å±‘</button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">
        <span class="icon">ğŸ‘¤</span>
        <span>ç”¨æˆ·ç®¡ç†</span>
      </div>
      <button onclick="setUser1()">ç”¨æˆ·1</button>
      <button onclick="setUser2()">ç”¨æˆ·2</button>
      <button onclick="clearUser()" class="secondary">æ¸…é™¤ç”¨æˆ·</button>
    </div>

    <div class="section">
      <div class="section-title">
        <span class="icon">âš™ï¸</span>
        <span>SDKæ§åˆ¶</span>
      </div>
      <button onclick="reinitSDK()">é‡æ–°åˆå§‹åŒ–</button>
      <button onclick="destroySDK()" class="secondary">é”€æ¯SDK</button>
      <button onclick="clearConsole()" class="secondary">æ¸…ç©ºæ§åˆ¶å°</button>
    </div>

    <div class="section">
      <div class="section-title">
        <span class="icon">ğŸ“Š</span>
        <span>äº‹ä»¶æ—¥å¿—</span>
      </div>
      <div class="console" id="console"></div>
    </div>
  </div>

  <script type="module">
    // æ¨¡æ‹Ÿæ‹¦æˆªç½‘ç»œè¯·æ±‚æ¥æ•è·ä¸ŠæŠ¥æ•°æ®
    let capturedReports = []
    let errorCount = 0

    // æ‹¦æˆªfetchæ¥æ•è·SDKä¸ŠæŠ¥çš„æ•°æ®
    const originalFetch = window.fetch
    window.fetch = function (...args) {
      const url = typeof args[0] === 'string' ? args[0] : String(args[0])

      // æ•è·å‘é€åˆ°SDKæœåŠ¡å™¨çš„è¯·æ±‚
      if (url.includes('your-server.com') || url.includes('collect')) {
        return originalFetch.apply(this, args).then(response => {
          // å…‹éš†å“åº”ä»¥é¿å…æ¶ˆè´¹åŸå§‹å“åº”
          return response.clone().json().then(data => {
            if (Array.isArray(data)) {
              capturedReports.push(...data)
            } else {
              capturedReports.push(data)
            }
            return response
          }).catch(() => response)
        })
      }

      return originalFetch.apply(this, args)
    }

    // å¯¼å…¥SDKï¼ˆä½¿ç”¨æ„å»ºåçš„æ–‡ä»¶ï¼‰
    import ErrorMonitorWeb from './packages/web/dist/index.mjs'

    let monitor = null

    // åˆå§‹åŒ–SDK
    function initSDK() {
      monitor = new ErrorMonitorWeb({
        appId: 'test-app',
        dsn: 'http://localhost:3001/api/collect',
        environment: 'testing',
        release: '1.0.0-test',
        sampleRate: 1.0,
        errorSampleRate: 1.0,
        debug: true,
        enabled: true,

        // æ‰¹é‡ä¸ŠæŠ¥é…ç½®
        report: {
          delay: 2000,        // 2ç§’åæ‰¹é‡ä¸ŠæŠ¥
          batchSize: 5,       // æ”¶é›†5ä¸ªé”™è¯¯åä¸ŠæŠ¥
          // è‡ªå®šä¹‰ä¸ŠæŠ¥å‡½æ•° - å°†é”™è¯¯å‘é€åˆ°æœ¬åœ°æœåŠ¡å™¨
          customReporter: (data) => {
            // æ£€æŸ¥æ˜¯æ‰¹é‡è¿˜æ˜¯å•ä¸ª
            const isBatch = data.reports && Array.isArray(data.reports)
            const reportData = isBatch ? data.reports : [data]

            reportData.forEach(report => {
              log(`ğŸ“¤ é”™è¯¯å·²ä¸ŠæŠ¥: ${report.type} - ${report.message.substring(0, 30)}`, 'success')
            })

            // å‘é€åˆ°æœåŠ¡å™¨
            fetch('http://localhost:3001/api/collect', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            }).catch(err => {
              log(`âŒ ä¸ŠæŠ¥å¤±è´¥: ${err.message}`, 'error')
            })
          }
        },

        // è‡ªåŠ¨æ•è·é…ç½®
        autoCapture: {
          js: true,
          promise: true,
          network: true,
          resource: true
        }
      })

      monitor.init()

      updateStatus()
      log('SDKåˆå§‹åŒ–æˆåŠŸ', 'success')
      log(`åº”ç”¨ID: test-app`, 'info')
      log(`ç¯å¢ƒ: testing`, 'info')
      log(`æ‰¹é‡é…ç½®: 5ä¸ªé”™è¯¯æˆ–2ç§’åä¸ŠæŠ¥`, 'info')
    }

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatus() {
      document.getElementById('sdkStatus').textContent = 'å·²åˆå§‹åŒ–'
      document.getElementById('sessionId').textContent = monitor.generateId().substring(0, 16) + '...'
      document.getElementById('errorCount').textContent = errorCount
      document.getElementById('environment').textContent = 'testing'
    }

    // æ—¥å¿—å‡½æ•°
    function log(message, type = 'info') {
      const consoleEl = document.getElementById('console')
      const time = new Date().toLocaleTimeString()
      const line = document.createElement('div')
      line.className = `console-line ${type}`
      line.innerHTML = `<span class="time">[${time}]</span>${message}`
      consoleEl.insertBefore(line, consoleEl.firstChild)

      // é™åˆ¶æ—¥å¿—æ¡æ•°
      while (consoleEl.children.length > 50) {
        consoleEl.removeChild(consoleEl.lastChild)
      }
    }

    // æ‰€æœ‰å…¨å±€å‡½æ•°å®šä¹‰
    window.testJSError = function() {
      try {
        throw new Error('æµ‹è¯•JSé”™è¯¯ï¼šè¿™æ˜¯ä¸€ä¸ªæ•…æ„çš„è¿è¡Œæ—¶é”™è¯¯ï¼')
      } catch (error) {
        monitor.captureError(error)
        errorCount++
        log('âœ“ å·²æ•è·JavaScripté”™è¯¯', 'success')
        document.getElementById('errorCount').textContent = errorCount
      }
    }

    window.testPromiseError = function() {
      Promise.reject('æµ‹è¯•Promiseé”™è¯¯ï¼šæœªå¤„ç†çš„rejection')
      log('âœ“ å·²è§¦å‘Promise rejection', 'success')
      setTimeout(() => {
        errorCount++
        document.getElementById('errorCount').textContent = errorCount
      }, 100)
    }

    window.testNetworkError = function() {
      fetch('https://invalid-domain-12345.com')
        .catch(() => {
          log('âœ“ å·²è§¦å‘ç½‘ç»œé”™è¯¯', 'success')
          setTimeout(() => {
            errorCount++
            document.getElementById('errorCount').textContent = errorCount
          }, 100)
        })
    }

    window.testResourceError = function() {
      const img = new Image()
      img.src = 'https://invalid-domain-12345.com/image.png'
      log('âœ“ å·²è§¦å‘èµ„æºåŠ è½½é”™è¯¯', 'success')
      setTimeout(() => {
        errorCount++
        document.getElementById('errorCount').textContent = errorCount
      }, 100)
    }

    window.testCustomMessage = function() {
      monitor.captureMessage('è¿™æ˜¯ä¸€æ¡è‡ªå®šä¹‰æ¶ˆæ¯', 'info')
      log('âœ“ å·²å‘é€è‡ªå®šä¹‰æ¶ˆæ¯', 'success')
    }

    window.testUnhandledError = function() {
      try {
        const obj = null
        obj.someMethod()
      } catch (error) {
        monitor.captureError(error)
        log('âœ“ å·²æ•è·æœªå¤„ç†é”™è¯¯: ' + error.message, 'success')
        errorCount++
        document.getElementById('errorCount').textContent = errorCount
      }
    }

    window.triggerSlowResource = function() {
      log('â³ æ¨¡æ‹ŸåŠ è½½æ…¢èµ„æº...', 'info')
      setTimeout(() => {
        log('âœ“ èµ„æºåŠ è½½å®Œæˆï¼ˆ2ç§’ï¼‰', 'success')
      }, 2000)
    }

    window.showWebVitals = function() {
      const entries = performance.getEntriesByType('navigation')
      if (entries.length > 0) {
        const lcp = Math.round(entries[0].loadEventEnd - entries[0].startTime)
        log('ğŸ“Š é¡µé¢åŠ è½½æ—¶é—´: ' + lcp + 'ms', 'info')
      } else {
        log('ğŸ“Š Web Vitals: N/A', 'info')
      }
    }

    window.checkPerformance = function() {
      const perfData = performance.getEntriesByType('navigation')[0]
      if (perfData) {
        log('ğŸ“Š æ€§èƒ½æŒ‡æ ‡:', 'info')

        const now = performance.now()
        const navigationStart = perfData.navigationStart || 0

        // DOMåŠ è½½æ—¶é—´
        let domLoadTime = perfData.domContentLoadedEventEnd - navigationStart
        if (domLoadTime <= 0 && perfData.domContentLoadedEventEnd === 0) {
          // é¡µé¢è¿˜æœªå®ŒæˆDOMåŠ è½½ï¼Œä½¿ç”¨å½“å‰æ—¶é—´ä¼°ç®—
          domLoadTime = now - navigationStart
          log(`  - DOMåŠ è½½: ${Math.round(domLoadTime)}ms (ä¼°ç®—)`, 'info')
        } else if (domLoadTime > 0) {
          log(`  - DOMåŠ è½½: ${Math.round(domLoadTime)}ms`, 'info')
        } else {
          log(`  - DOMåŠ è½½: åŠ è½½ä¸­...`, 'info')
        }

        // å®Œå…¨åŠ è½½æ—¶é—´
        let loadTime = perfData.loadEventEnd - navigationStart
        if (loadTime <= 0 && perfData.loadEventEnd === 0) {
          // é¡µé¢è¿˜æœªå®Œå…¨åŠ è½½ï¼Œä½¿ç”¨å½“å‰æ—¶é—´ä¼°ç®—
          loadTime = now - navigationStart
          log(`  - å®Œå…¨åŠ è½½: ${Math.round(loadTime)}ms (ä¼°ç®—)`, 'info')
        } else if (loadTime > 0) {
          log(`  - å®Œå…¨åŠ è½½: ${Math.round(loadTime)}ms`, 'info')
        } else {
          log(`  - å®Œå…¨åŠ è½½: åŠ è½½ä¸­...`, 'info')
        }

        // æ·»åŠ æç¤º
        if (perfData.loadEventEnd === 0) {
          log(`  ğŸ’¡ æç¤º: é¡µé¢ä»åœ¨åŠ è½½ä¸­ï¼Œä»¥ä¸Šä¸ºä¼°ç®—å€¼`, 'info')
        }
      } else {
        log('ğŸ“Š æ€§èƒ½æŒ‡æ ‡: æš‚æ— æ•°æ®', 'info')
      }
    }

    window.simulateClick = function() {
      log('ğŸ–±ï¸ ç‚¹å‡»äº‹ä»¶æµ‹è¯•', 'info')
    }

    window.simulateNavigation = function() {
      const newPath = '/test/' + Date.now()
      history.pushState({}, '', newPath)
      log(`ğŸ”€ è·¯ç”±å˜åŒ–: ${newPath}`, 'info')
    }

    window.simulateHttp = function() {
      log('ğŸŒ å‘èµ·HTTPè¯·æ±‚...', 'info')
      fetch('https://api.github.com/users/github')
        .then(res => res.json())
        .then(data => {
          log(`âœ“ HTTPæˆåŠŸ: ${data.login}`, 'success')
        })
        .catch(err => {
          log(`âœ— HTTPå¤±è´¥: ${err.message}`, 'error')
        })
    }

    window.addCustomBreadcrumb = function() {
      monitor.addBreadcrumb({
        timestamp: Date.now(),
        type: 'custom',
        message: 'è‡ªå®šä¹‰äº‹ä»¶',
        data: { action: 'test', value: Math.random() }
      })
      log('âœ“ å·²æ·»åŠ è‡ªå®šä¹‰é¢åŒ…å±‘', 'success')
    }

    window.setUser1 = function() {
      monitor.setUser({
        id: 'user-1',
        username: 'æµ‹è¯•ç”¨æˆ·1',
        email: 'user1@test.com'
      })
      document.getElementById('currentUser').textContent = 'user-1'
      log('âœ“ å·²è®¾ç½®ç”¨æˆ·: user-1', 'success')
    }

    window.setUser2 = function() {
      monitor.setUser({
        id: 'user-2',
        username: 'æµ‹è¯•ç”¨æˆ·2',
        email: 'user2@test.com'
      })
      document.getElementById('currentUser').textContent = 'user-2'
      log('âœ“ å·²è®¾ç½®ç”¨æˆ·: user-2', 'success')
    }

    window.clearUser = function() {
      monitor.setUser({})
      document.getElementById('currentUser').textContent = 'æœªè®¾ç½®'
      log('âœ“ å·²æ¸…é™¤ç”¨æˆ·ä¿¡æ¯', 'success')
    }

    window.reinitSDK = function() {
      if (monitor) {
        monitor.destroy()
      }
      errorCount = 0
      initSDK()
      log('âœ“ SDKå·²é‡æ–°åˆå§‹åŒ–', 'success')
    }

    window.destroySDK = function() {
      monitor.destroy()
      document.getElementById('sdkStatus').textContent = 'å·²é”€æ¯'
      log('âœ“ SDKå·²é”€æ¯', 'success')
    }

    window.clearConsole = function() {
      document.getElementById('console').innerHTML = ''
      log('æ§åˆ¶å°å·²æ¸…ç©º', 'info')
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('load', () => {
      initSDK()
      log('ğŸš€ æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ', 'success')
    })
  </script>
</body>
</html>
