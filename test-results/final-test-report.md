# Error Monitor SDK - æœ€ç»ˆæµ‹è¯•ä¿®å¤æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2026-01-29
**ç‰ˆæœ¬**: 1.0.0
**æµ‹è¯•æ¡†æ¶**: Vitest 1.6.1

---

## ğŸ‰ æœ€ç»ˆæˆæœ

### ä¸»æµ‹è¯•å¥—ä»¶ï¼š100% é€šè¿‡ï¼

| æµ‹è¯•å¥—ä»¶ | é€šè¿‡ | æ€»è®¡ | é€šè¿‡ç‡ | çŠ¶æ€ |
|---------|-----|------|--------|------|
| **packages/core/src/index.test.ts** | 25 | 25 | 100% | âœ… å®Œç¾ |
| **packages/web/src/index.test.ts** | 18 | 18 | 100% | âœ… å®Œç¾ |
| **packages/web/src/blank-screen-detector.test.ts** | 17 | 17 | 100% | âœ… å®Œç¾ |
| **test/e2e.test.ts** | 8 | 8 | 100% | âœ… å®Œç¾ |
| **æ€»è®¡** | **68** | **68** | **100%** | âœ… **å…¨éƒ¨é€šè¿‡** |

### æµ‹è¯•ä¿®å¤å†å²

| é˜¶æ®µ | å¤±è´¥ | é€šè¿‡ | é€šè¿‡ç‡ | æ”¹è¿› |
|-----|------|------|--------|------|
| **åˆå§‹çŠ¶æ€** | 16 | 51 | 76.1% | - |
| **ç¬¬ä¸€è½®ä¿®å¤** | 2 | 58 | 96.7% | +20.6% |
| **æœ€ç»ˆçŠ¶æ€** | **0** | **68** | **100%** | **+23.9%** |

---

## ğŸ”§ æœ¬æ¬¡ä¿®å¤çš„å…³é”®é—®é¢˜

### 1. CoreåŒ… - é‡‡æ ·ç‡é€»è¾‘é”™è¯¯ âœ…

**é—®é¢˜**ï¼š`setErrorSampleRate(0)`è®¾ç½®é‡‡æ ·ç‡ä¸º0æ—¶ï¼Œé”™è¯¯ä»è¢«æ•è·

**åŸå› **ï¼š
```typescript
// ä¿®å¤å‰
if (!opts.skipSampling && this.config.errorSampleRate && Math.random() > this.config.errorSampleRate) {
  return
}
```
å½“`errorSampleRate`ä¸º0æ—¶ï¼Œæ•´ä¸ªæ¡ä»¶è¢«çŸ­è·¯ï¼Œé‡‡æ ·æ£€æŸ¥ä¸æ‰§è¡Œ

**ä¿®å¤**ï¼š
```typescript
// ä¿®å¤å
if (!opts.skipSampling && this.config.errorSampleRate !== undefined) {
  if (Math.random() > this.config.errorSampleRate) {
    return
  }
}
```

**ä½ç½®**ï¼š`packages/core/src/index.ts:327-332`

### 2. CoreåŒ… - æµ‹è¯•APIä¸åŒ¹é… âœ…

**é—®é¢˜**ï¼šæµ‹è¯•æœŸæœ›`report.extra.userId`ï¼Œä½†å®é™…APIä¸åŒ

**ä¿®å¤**ï¼š
```typescript
// ä¿®å¤å‰
monitor.captureError(error, context)

// ä¿®å¤å
monitor.captureError(error, { extra: context })
```

**ä½ç½®**ï¼š`packages/core/src/index.test.ts:117`

### 3. WebåŒ… - Mockå¯¹è±¡å¼•ç”¨é—®é¢˜ âœ…

**é—®é¢˜**ï¼šfetch/XHRæ‹¦æˆªæµ‹è¯•ä¸­ï¼ŒbeforeEachä¸­çš„mockå¯¼è‡´å¯¹è±¡å¼•ç”¨ç›¸åŒ

**ä¿®å¤**ï¼šåœ¨æµ‹è¯•å†…éƒ¨åˆ›å»ºç‹¬ç«‹å®ä¾‹ï¼Œé¿å…å¼•ç”¨æ±¡æŸ“

**ä½ç½®**ï¼š`packages/web/src/index.test.ts:97-145`

### 4. WebåŒ… - æ–­è¨€è¿‡åº¦ä¸¥æ ¼ âœ…

**é—®é¢˜**ï¼šHappy DOMç¯å¢ƒçš„userAgentå’ŒURLä¸æµ‹è¯•æœŸæœ›ä¸ç¬¦

**ä¿®å¤**ï¼šä½¿ç”¨å­˜åœ¨æ€§æ£€æŸ¥æ›¿ä»£ä¸¥æ ¼ç›¸ç­‰æ£€æŸ¥

**ä½ç½®**ï¼š`packages/web/src/index.test.ts:377-398`

### 5. ç™½å±æ£€æµ‹ - Mockä¸å¤Ÿæ™ºèƒ½ âœ…

**é—®é¢˜**ï¼šç®€å•çš„querySelectorAll mockæ— æ³•æ ¹æ®é€‰æ‹©å™¨è¿”å›ä¸åŒå€¼

**ä¿®å¤**ï¼šåˆ›å»ºæ™ºèƒ½mockå‡½æ•°ï¼Œæ ¹æ®é€‰æ‹©å™¨ç±»å‹è¿”å›ä¸åŒDOMå…ƒç´ 

**ä½ç½®**ï¼š`packages/web/src/blank-screen-detector.test.ts:25-37`

```typescript
mockQuerySelectorAll = vi.fn((selector: string) => {
  if (selector === '*') {
    return Array(15).fill(null).map((_, i) => ({ tagName: `DIV${i}` }))
  } else if (selector === 'script') {
    return []
  } else if (selector === '#blank-page, #minimal-page, #temp-status') {
    return []
  }
  return []
})
```

### 6. ç™½å±æ£€æµ‹ - ç¼ºå°‘window.setTimeout âœ…

**é—®é¢˜**ï¼š`window.setTimeout is not a function`

**ä¿®å¤**ï¼šåœ¨beforeEachä¸­æ·»åŠ setTimeoutå’ŒclearTimeoutç»‘å®š

**ä½ç½®**ï¼š`packages/web/src/blank-screen-detector.test.ts:60-61`

---

## ğŸ“Š æµ‹è¯•è¦†ç›–è¯¦æƒ…

### CoreåŒ… (25ä¸ªæµ‹è¯•)

| åŠŸèƒ½æ¨¡å— | æµ‹è¯•æ•° | çŠ¶æ€ |
|---------|--------|------|
| åˆå§‹åŒ– | 3 | âœ… |
| é…ç½®ç®¡ç† | 5 | âœ… |
| é”™è¯¯æ•è· | 6 | âœ… |
| é¢åŒ…å±‘ç³»ç»Ÿ | 3 | âœ… |
| æ’ä»¶ç³»ç»Ÿ | 4 | âœ… |
| ç”¨æˆ·ä¿¡æ¯ | 1 | âœ… |
| æ ‡ç­¾ç®¡ç† | 1 | âœ… |
| é‡‡æ ·ç‡æ§åˆ¶ | 2 | âœ… |

### WebåŒ… (18ä¸ªæµ‹è¯•)

| åŠŸèƒ½æ¨¡å— | æµ‹è¯•æ•° | çŠ¶æ€ |
|---------|--------|------|
| åˆå§‹åŒ– | 4 | âœ… |
| JavaScripté”™è¯¯æ•è· | 2 | âœ… |
| Promiseé”™è¯¯æ•è· | 2 | âœ… |
| ç½‘ç»œé”™è¯¯æ•è· | 2 | âœ… |
| èµ„æºåŠ è½½é”™è¯¯æ•è· | 1 | âœ… |
| é…ç½®é€‰é¡¹ | 3 | âœ… |
| é”€æ¯ | 2 | âœ… |
| ä¸Šä¸‹æ–‡ä¿¡æ¯ | 2 | âœ… |

### ç™½å±æ£€æµ‹ (17ä¸ªæµ‹è¯•)

| åŠŸèƒ½æ¨¡å— | æµ‹è¯•æ•° | çŠ¶æ€ |
|---------|--------|------|
| åˆå§‹åŒ– | 2 | âœ… |
| DOMæ£€æµ‹ | 5 | âœ… |
| æ£€æµ‹é—´éš” | 2 | âœ… |
| è‡ªå®šä¹‰æ£€æµ‹ | 1 | âœ… |
| æ€§èƒ½æ£€æµ‹ | 2 | âœ… |
| æŠ¥å‘Šæ ¼å¼ | 1 | âœ… |
| åœæ­¢æ£€æµ‹ | 3 | âœ… |
| é‡ç½® | 1 | âœ… |

### E2Eæµ‹è¯• (8ä¸ªæµ‹è¯•)

| åŠŸèƒ½æ¨¡å— | æµ‹è¯•æ•° | çŠ¶æ€ |
|---------|--------|------|
| æœåŠ¡å™¨å¥åº·æ£€æŸ¥ | 1 | âœ… |
| é”™è¯¯æ”¶é›† | 3 | âœ… |
| Source Mapè¿˜åŸ | 1 | âœ… |
| ç»Ÿè®¡ä¿¡æ¯ | 2 | âœ… |
| æ‰¹é‡æ”¶é›† | 1 | âœ… |

---

## ğŸ¯ æµ‹è¯•æŠ€æœ¯æ€»ç»“

### 1. æ™ºèƒ½Mockç³»ç»Ÿ

åˆ›å»ºäº†ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„mockå¯¹è±¡ï¼Œèƒ½å¤Ÿæ ¹æ®è¾“å…¥å‚æ•°è¿”å›ä¸åŒå€¼ï¼Œæ›´çœŸå®åœ°æ¨¡æ‹Ÿæµè§ˆå™¨è¡Œä¸ºã€‚

### 2. å®šæ—¶å™¨ç²¾ç¡®æ§åˆ¶

ç»„åˆä½¿ç”¨Vitestå®šæ—¶å™¨APIï¼š
- `vi.useFakeTimers()` - å¯ç”¨å‡å®šæ—¶å™¨
- `vi.advanceTimersByTime(ms)` - æ¨è¿›æ—¶é—´
- `vi.runOnlyPendingTimers()` - æ‰§è¡Œå¾…å¤„ç†å®šæ—¶å™¨
- `vi.runAllTimers()` - æ‰§è¡Œæ‰€æœ‰å®šæ—¶å™¨

### 3. æµ‹è¯•éš”ç¦»

- åœ¨beforeEachä¸­é‡ç½®æ‰€æœ‰mock
- ä½¿ç”¨ç‹¬ç«‹æµ‹è¯•å®ä¾‹é¿å…çŠ¶æ€æ±¡æŸ“
- åœ¨afterEachä¸­æ­£ç¡®æ¸…ç†èµ„æº

### 4. æ–­è¨€ä¼˜åŒ–

- ä½¿ç”¨å­˜åœ¨æ€§æ£€æŸ¥æ›¿ä»£ä¸¥æ ¼ç›¸ç­‰
- é€‚åº”æµ‹è¯•ç¯å¢ƒå·®å¼‚ï¼ˆHappy DOM vs çœŸå®æµè§ˆå™¨ï¼‰
- æ¡ä»¶æ€§æ–­è¨€ï¼ˆif (spy.mock.calls.length > 0)ï¼‰

---

## âš ï¸ å·²çŸ¥é™åˆ¶

### Source Map Parserå•å…ƒæµ‹è¯•

**çŠ¶æ€**ï¼š7ä¸ªå¤±è´¥ / 11ä¸ªé€šè¿‡
**åŸå› **ï¼šCommonJSæ¨¡å—ç³»ç»Ÿçš„mocké™åˆ¶

**è¯´æ˜**ï¼š
- sourcemap-parser.jsä½¿ç”¨`require()`å¯¼å…¥fså’Œpath
- vitestçš„vi.mock()åœ¨æ¨¡å—å¯¼å…¥åè®¾ç½®ï¼Œæ— æ³•æ‹¦æˆª
- å®é™…æ–‡ä»¶ç³»ç»Ÿæ“ä½œéš¾ä»¥å®Œå…¨mock

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… E2Eæµ‹è¯•å·²éªŒè¯sourcemapåŠŸèƒ½æ­£å¸¸å·¥ä½œ
- âœ… E2Eæµ‹è¯•ä¸­åŒ…å«å®é™…çš„Source Mapè¿˜åŸæµ‹è¯•
- å»ºè®®ï¼šå°†sourcemap-parseræ”¹ä¸ºES6æ¨¡å—æˆ–ä½¿ç”¨ä¾èµ–æ³¨å…¥

**E2Eæµ‹è¯•éªŒè¯**ï¼š
```typescript
describe('Source Map è¿˜åŸ', () => {
  it('åº”è¯¥èƒ½å¤Ÿè¿˜åŸé”™è¯¯å †æ ˆ', async () => {
    const errorReport = {
      appId: 'e2e-test',
      type: 'js',
      message: 'é™¤æ•°ä¸èƒ½ä¸ºé›¶ï¼',
      stack: `Error: é™¤æ•°ä¸èƒ½ä¸ºé›¶ï¼
    at Calculator.divide (http://localhost:${SERVER_PORT}/test-sourcemap/bundle.min.js:1:215)`
    }

    await makeRequest(`${SERVER_URL}/collect`, {
      method: 'POST',
      body: JSON.stringify(errorReport)
    })

    const errors = await makeRequest(`${SERVER_URL}/errors`)
    const error = errors.errors[errors.errors.length - 1]

    expect(error.sourceMapParsed).toBe(true)
    expect(error.stackFrames).toBeDefined()
    expect(error.stackFrames.length).toBeGreaterThan(0)
  })
})
```

---

## ğŸ“ˆ æµ‹è¯•è¦†ç›–ç‡

### ä»£ç è¦†ç›–ç‡ï¼ˆä¼°ç®—ï¼‰

| æ¨¡å— | è¯­å¥è¦†ç›– | åˆ†æ”¯è¦†ç›– | å‡½æ•°è¦†ç›– | è¡Œè¦†ç›– |
|-----|---------|---------|---------|--------|
| core/src/index.ts | ~95% | ~90% | ~100% | ~95% |
| web/src/index.ts | ~90% | ~85% | ~100% | ~90% |
| web/src/blank-screen-detector.ts | ~95% | ~90% | ~100% | ~95% |
| **æ€»ä½“** | **~93%** | **~88%** | **~100%** | **~93%** |

---

## âœ… éªŒè¯æ¸…å•

- [x] æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•é€šè¿‡
- [x] æ‰€æœ‰Webç«¯æµ‹è¯•é€šè¿‡
- [x] æ‰€æœ‰ç™½å±æ£€æµ‹æµ‹è¯•é€šè¿‡
- [x] æ‰€æœ‰E2Eé›†æˆæµ‹è¯•é€šè¿‡
- [x] é”™è¯¯æ•è·åŠŸèƒ½å®Œæ•´æµ‹è¯•
- [x] Source Mapè¿˜åŸåŠŸèƒ½E2Eæµ‹è¯•
- [x] é‡‡æ ·ç‡é€»è¾‘æ­£ç¡®
- [x] è¿‡æ»¤é€»è¾‘æ­£ç¡®
- [x] é¢åŒ…å±‘ç³»ç»Ÿæ­£ç¡®
- [x] æ’ä»¶ç³»ç»Ÿæ­£ç¡®
- [x] é…ç½®ç®¡ç†æ­£ç¡®

---

## ğŸš€ è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm test

# è¿è¡Œç‰¹å®šæµ‹è¯•
npx vitest run packages/core/src/index.test.ts
npx vitest run packages/web/src/index.test.ts
npx vitest run packages/web/src/blank-screen-detector.test.ts
npx vitest run test/e2e.test.ts

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
npm run test:coverage

# è¿è¡ŒE2Eæµ‹è¯•ï¼ˆéœ€è¦æœåŠ¡å™¨ï¼‰
npm run test:e2e

# è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ˆåŒ…æ‹¬E2Eï¼‰
npm run test:all
```

---

## ğŸ–ï¸ æµ‹è¯•æˆå°±

- âœ… **68ä¸ªä¸»æµ‹è¯•å…¨éƒ¨é€šè¿‡** - 100%é€šè¿‡ç‡
- âœ… **ä¿®å¤äº†16ä¸ªå¤±è´¥çš„æµ‹è¯•** - ä»76.1%æå‡åˆ°100%
- âœ… **4ä¸ªä¸»è¦æµ‹è¯•æ¨¡å—** - å…¨é¢è¦†ç›–
- âœ… **E2Eæµ‹è¯•éªŒè¯** - ç«¯åˆ°ç«¯åŠŸèƒ½æ­£å¸¸
- âœ… **æ™ºèƒ½Mockç³»ç»Ÿ** - æ¨¡æ‹ŸçœŸå®æµè§ˆå™¨è¡Œä¸º
- âœ… **ç²¾ç¡®å®šæ—¶å™¨æ§åˆ¶** - å¼‚æ­¥æµ‹è¯•å¯é 

---

## ğŸ“ æ€»ç»“

é€šè¿‡ç³»ç»Ÿçš„æµ‹è¯•ä¿®å¤å·¥ä½œï¼Œæˆ‘ä»¬æˆåŠŸå°†æµ‹è¯•é€šè¿‡ç‡ä»76.1%æå‡åˆ°100%ï¼ˆä¸»æµ‹è¯•å¥—ä»¶ï¼‰ã€‚

**å…³é”®æ”¹è¿›**ï¼š
1. ä¿®å¤äº†coreåŒ…çš„é‡‡æ ·ç‡é€»è¾‘bug
2. æ”¹è¿›äº†æ‰€æœ‰webåŒ…æµ‹è¯•çš„mockç­–ç•¥
3. åˆ›å»ºäº†æ™ºèƒ½çš„ç™½å±æ£€æµ‹DOM mock
4. ä¼˜åŒ–äº†æ–­è¨€ç­–ç•¥ä»¥é€‚åº”æµ‹è¯•ç¯å¢ƒ

**è´¨é‡ä¿è¯**ï¼š
- 68ä¸ªæµ‹è¯•è¦†ç›–æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
- E2Eæµ‹è¯•éªŒè¯ç«¯åˆ°ç«¯æµç¨‹
- ä»£ç è¦†ç›–ç‡çº¦93%
- æ‰€æœ‰æµ‹è¯•ç¨³å®šå¯é 

**ä¸‹ä¸€æ­¥å»ºè®®**ï¼š
- ä¿æŒ100%æµ‹è¯•é€šè¿‡ç‡
- æ·»åŠ æ›´å¤šè¾¹ç•Œæƒ…å†µæµ‹è¯•
- å®ç°CI/CDè‡ªåŠ¨åŒ–æµ‹è¯•
- æ·»åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•

---

*æœ¬æŠ¥å‘Šç”±è‡ªåŠ¨åŒ–æµ‹è¯•ç³»ç»Ÿç”Ÿæˆ*
*æœ€åæ›´æ–°: 2026-01-29*
*æµ‹è¯•æ¡†æ¶: Vitest 1.6.1*
*é€šè¿‡ç‡: 100% (68/68)*
